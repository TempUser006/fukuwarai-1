<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    canvas{
        width: 100%;
    }
    .main-btn{
        border-radius: 2em;
        padding: 1em;
        font-size: x-large;
    }
    ons-icon{
        width :2em;
        height:2em;
    }
    .page__background{
        background-image:  url("./image/parts/bg.jpg");
        background-repeat: repeat;
        background-position: center;
    }
  </style>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/b64utils.js"></script>
  <script src="js/saveImage.js"></script>
  <script src="js/display.js"></script>
  <script src="js/animation.js"></script>
  <script src="js/roulette.js"></script>
  <!--<script src="js/imageSave.js"></script>-->
  <script>
        $.ajaxSetup({ cache: false });
        var img = [];//元画像配列
        var rou = [];//ルーレット画像配列
        var fuk = [];//福笑い画像配列
        /********
         *ページ*
         ********/
        document.addEventListener('init', function(event) {
          var page = event.target;
        
        if (page.id === ('first-page')) {
        }else if(page.id === "second-page") {
            // tab2.htmlに対するDOM操作
            document.getElementById("picture").src = page.data.img;
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }else if(page.id === "third-page"){
            canvas_fukuwarai(fuk);
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }else if(page.id === "fourth-page"){
            canvas_roulette(rou);
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }
          
        });
        /********
         * 写真 *
         ********/
        function snapPicture () {//カメラ撮影
            navigator.camera.getPicture (onSuccess, onFail,
                                         { quality: 50, destinationType: Camera.DestinationType.DATA_URL});
            //A callback function when snapping picture is success.
            function onSuccess (imageData) {
                document.querySelector('#navigator').pushPage('page2.html',{data:{img:"data:image/jpeg;base64,"+imageData}});
                img.push(imageData);
                console.log(img.length);
            }
        
            //A callback function when snapping picture is fail.
            function onFail (message) {
                alert ('Error occured: ' + message);
            }
        }
        function getPhoto () {//カメラロール        
            navigator.camera.getPicture(onSuccess, onFail, { quality: 50,destinationType: Camera.DestinationType.DATA_URL,
              sourceType: navigator.camera.PictureSourceType.SAVEDPHOTOALBUM });
            function onSuccess (imageData) {
                document.querySelector('#navigator').pushPage('page2.html',{data:{img:"data:image/jpeg;base64,"+imageData}});
                
                img.push(imageData);
                console.log(img.length);
            }
            function onFail (message) {
                alert('An error Occured: ' + message);
            }
        }
        
        
        function Fukuwarai () {
            var Fupload = F_upload('fukuwarai',img);
            $.when(Fupload).done(function(res){
                fuk = res;
                document.querySelector('#navigator').pushPage('page3.html');
            });
        }
        function SaveFukuwarai () {
          var myCanvas = $('#fukuCanvas').get(0);
          var url = myCanvas.toDataURL("image/png");
          var base64data = url.split(',')[1];
 
          var array = b64utils.decode( base64data );
            
          window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fs) {  
            fs.root.getFile("myimage.png" , {create:true, exclusive:false}, 
              function(entry) {
                entry.createWriter( 
                  function(writer) {
 
                    var cb = function() {
                      console.log("write end"); alert("Save OK");
                    }
 
                    writer.onwrite = cb;
                    writer.onerror = function() { console.log("write error"); }
                    writer.write( array );
 
                  } ,
                  function() {
                    console.log("create write error");
                  }
                );
              } ,
              function(){ }
            );
          }, function() { });
        }
        function Roulette () {
            var Fupload = F_upload('roulette',img);
            $.when(Fupload).done(function(res){
                rou = res;
                document.querySelector('#navigator').pushPage('page4.html');
            });
        }
        function F_upload(method,image){
                var defer = new $.Deferred();
                console.log(image);
                $.ajax({
                    url:'http://fukuwarai-app.herokuapp.com/image',//TODO::かく
                    type:'POST',
                    contentType:'application/json; charset=utf-8',
                    //dataType: 'binary',
                    //responseType:'blob',
                    dataType: 'text',
                    data: JSON.stringify({
                        'image' : String( image ),
                        'method': method
                    }),
                    success:function(data){
                        console.log("succeed");
                    },error : function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("XMLHttpRequest : " + XMLHttpRequest.status);
                        console.log("textStatus : " + textStatus);
                        console.log("errorThrown : " + errorThrown.message);
                    }
                })
                .done(function(data){
                    switch(method){
                        case 'fukuwarai':
                            fuk.push(data);
                            console.log(data);
                            break;
                        case 'roulette':
                            rou.push(data);
                            break;
                        default:
                            break;
                    }
                    defer.resolve(data);
                })
                .fail(function(){
                    console.log('エラー');
                });
            return defer.promise(this);
        }
  </script>
</head>
<body>
  <ons-navigator var="navi" id="navigator" page="page1.html"></ons-navigator>

  <ons-template id="page1.html">
    <ons-page id="first-page">
        <div class="content" style="text-align: center">
          <h1>Fukuwarai</h1>
        <ons-button id="to-cam" onclick="snapPicture()" class="main-btn"><ons-icon icon="fa-camera"></ons-icon></ons-button>
        <ons-button id="to-lib" onclick="getPhoto()" class="main-btn"><ons-icon icon="fa-picture-o"></ons-icon></ons-button>
        </div>
    </ons-page>
  </ons-template>

  <ons-template id="page2.html">
    <ons-page id="second-page">

      <div class="content" style="text-align: center">
        <div id="imgarea">
            <img id="picture" src="" style="width:100%" />
        </div>
        <ons-button id="pop-button">やり直す</ons-button>
        <ons-button id="do-button">実行</ons-button>
        <br /><br />
        <ons-button id="to-fuk" onclick="Fukuwarai()"><ons-icon icon="fa-picture-o"></ons-icon>福笑い</ons-button>
        <br /><br />
        <ons-button id="to-rou" onclick="Roulette()"><ons-icon icon="fa-picture-o"></ons-icon>ルーレット</ons-button>
          
        <br /><br />
        <ons-button id="to-cam" onclick="snapPicture()" class="main-btn"><ons-icon icon="fa-camera"></ons-icon></ons-button>
        <ons-button id="to-lib" onclick="getPhoto()" class="main-btn"><ons-icon icon="fa-picture-o"></ons-icon></ons-button>
      </div>
    </ons-page>
  </ons-template>
  
  <ons-template id="page3.html">
    <ons-page id="third-page" style="text-align: center">
        <canvas id="fukuCanvas" height="300" width="470"></canvas>
        <ons-button id="save_fukuwarai" onclick="SaveFukuwarai();">保存する</ons-button>
        <ons-button id="display" onclick="loadImage();">表示する</ons-button>
        <ons-button id="confirm" onclick="onDeviceReady();">保存する</ons-button>
        <ons-button id="pop-button">やり直す</ons-button>
    </ons-page>
  </ons-template>
    <ons-template id="page4.html">
    <ons-page id="fourth-page">
      <div class="content" style="text-align: center">
        <ons-button id="start">スタート！</ons-button>
        <div id="canvases">
            <canvas id="top" width="400" height="50"></canvas>      
            <canvas id="middle" width="400" height="50"></canvas>
            <canvas id="bottom" width="400" height="50"></canvas>
            <ons-button id="top_stop">ストップ01</ons-button>
            <ons-button id="middle_stop">ストップ02</ons-button>
            <ons-button id="bottom_stop">ストップ03</ons-button>
        </div>
        <br />
        <ons-button id="pop-button">やり直す</ons-button>
      </div>
    </ons-page>
  </ons-template>
</body>
</html>