<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">

    <style>
      canvas{
          width: 100%;
      }
        .main-btn{
            border-radius: 2em;
            padding: 1em;
            font-size: x-large;
        }
        ons-icon{
            width :2em;
            height:2em;
        }
    </style>  
  
  <script src="js/animation.js"></script>
  <script src="js/roulette.js"></script>
  <script src="js/b64utils.js"></script>
  <script>
        /********
         *ページ*
         ********/
        document.addEventListener('init', function(event) {
          var page = event.target;
        
        if (page.id === ('first-page')) {
        }else if(page.id === "second-page") {
            // tab2.htmlに対するDOM操作
            document.getElementById("picture").src = page.data.img;
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }else if(page.id === "third-page"){
            canvas_fukuwarai();
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }else if(page.id === "fourth-page"){
            canvas_roulette();
            page.querySelector('#pop-button').onclick = function() {
              document.querySelector('#navigator').popPage();
            }
        }
          
        var img = null;
        });
        /********
         * 写真 *
         ********/
        function snapPicture () {
            navigator.camera.getPicture (onSuccess, onFail,
                                         { quality: 50, destinationType: Camera.DestinationType.DATA_URL});
            //A callback function when snapping picture is success.
            function onSuccess (imageData) {
                document.querySelector('#navigator').pushPage('page2.html',{data:{img:"data:image/jpeg;base64,"+imageData}});
        //             console.log('Success!');
        //             var image = document.getElementById ('picture');
        //             image.src = "data:image/jpeg;base64," + imageData;
            }
        
            //A callback function when snapping picture is fail.
            function onFail (message) {
                alert ('Error occured: ' + message);
            }
        }
        function getPhoto () {            
            navigator.camera.getPicture(onSuccess, onFail, { quality: 50,destinationType: Camera.DestinationType.FILE_URI,
              sourceType: navigator.camera.PictureSourceType.SAVEDPHOTOALBUM });
            function onSuccess (imageURI) {
                document.querySelector('#navigator').pushPage('page2.html',{data:{img:imageURI}});
                
                console.log('Success!');
                document.getElementById('picture').src = imageURI;
            }
            function onFail (message) {
                alert('An error Occured: ' + message);
            }
        }
        
        
        function Fukuwarai () {
            document.querySelector('#navigator').pushPage('page3.html');
        }
        function SaveFukuwarai () {
          var myCanvas = $("canvas#canvas").get(0);
          var url = myCanvas.toDataURL("image/png");
          var base64data = url.split(',')[1];
 
          var array = b64utils.decode( base64data );
            
          window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fs) {  
            fs.root.getFile("myimage.png" , {create:true, exclusive:false}, 
              function(entry) {
                entry.createWriter( 
                  function(writer) {
 
                    var cb = function() {
                      console.log("write end"); alert("Save OK");
                    }
 
                    writer.onwrite = cb;
                    writer.onerror = function() { console.log("write error"); }
                    writer.write( array );
 
                  } ,
                  function() {
                    console.log("create write error");
                  }
                );
              } ,
              function(){ }
            );
          }, function() { });
        }
        function Roulette () {
            document.querySelector('#navigator').pushPage('page4.html');
        }
  </script>
</head>
<body>
  <ons-navigator var="navi" id="navigator" page="page1.html"></ons-navigator>

  <ons-template id="page1.html">
    <ons-page id="first-page">
        <div class="content" style="text-align: center">
          <h1>Fukuwarai</h1>
        <ons-button id="to-cam" onclick="snapPicture()" class="main-btn"><ons-icon icon="fa-camera"></ons-icon></ons-button>
        <ons-button id="to-lib" onclick="getPhoto()" class="main-btn"><ons-icon icon="fa-picture-o"></ons-icon></ons-button>
        </div>
    </ons-page>
  </ons-template>

  <ons-template id="page2.html">
    <ons-page id="second-page">

      <div class="content" style="text-align: center">
        <p>画像取得後のページ</p>
        <div id="imgarea">
            <img id="picture" src="" style="width:100%" />
        </div>
        <ons-button id="pop-button">やり直す</ons-button>
        <ons-button id="do-button">実行</ons-button>
        <br /><br />
        <ons-button id="to-fuk" onclick="Fukuwarai()"><ons-icon icon="fa-picture-o"></ons-icon> 福笑い</ons-button>
        <br /><br />
        <ons-button id="to-rou" onclick="Roulette()"><ons-icon icon="fa-picture-o"></ons-icon> ルーレット</ons-button>
          
        <br /><br />
        <ons-button id="to-cam" onclick="snapPicture()" class="main-btn"><ons-icon icon="fa-camera"></ons-icon></ons-button>
        <ons-button id="to-lib" onclick="getPhoto()" class="main-btn"><ons-icon icon="fa-picture-o"></ons-icon></ons-button>
      </div>
    </ons-page>
  </ons-template>
  
  <ons-template id="page3.html">
    <ons-page id="third-page" style="text-align: center">
        <canvas id="canvas" height="500" width="470"></canvas>
        <ons-button id="save_fukuwarai" onclick="SaveFukuwarai()">保存する</ons-button>
        <ons-button id="pop-button">やり直す</ons-button>
    </ons-page>
  </ons-template>
    <ons-template id="page4.html">
    <ons-page id="fourth-page">
      <div class="content" style="text-align: center">
        <ons-button id="start">スタート！</ons-button>
        <div id="canvases">
            <canvas id="top" width="300" height="50"></canvas>      
            <canvas id="middle" width="300" height="50"></canvas>
            <canvas id="bottom" width="300" height="50"></canvas>
            <ons-button id="top_stop">ストップ01</ons-button>
            <ons-button id="middle_stop">ストップ02</ons-button>
            <ons-button id="bottom_stop">ストップ03</ons-button>
        </div>
        <br />
        <ons-button id="pop-button">やり直す</ons-button>
      </div>
    </ons-page>
  </ons-template>
</body>
</html>